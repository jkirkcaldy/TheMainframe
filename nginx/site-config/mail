upstream exchange {
      server 192.168.1.6:443;
      server 192.168.1.7:443;
      }


server {
        listen 10.10.0.253:80;
        server_name mail.themainframe.co.uk autodiscover.themainframe.co.uk;
        return 301 https://$host$request_uri;
}

server {
        listen 10.10.0.253:443 ssl http2;
        server_name mail.themainframe.co.uk;
        return 444;
        include /etc/nginx/config/sub-strong-ssl.conf;
        include /etc/nginx/config/proxy.conf;
        include /etc/nginx/config/cloudflare.conf;

        location / {
                return 301 https://mail.themainframe.co.uk/owa;
        }
        proxy_pass_header       Date;
        proxy_pass_header       Server;
        proxy_pass_header       Authorization;
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
		    proxy_request_buffering off;
		    proxy_buffering off;
		    proxy_set_header Connection "Keep-Alive";

        more_set_input_headers 'Authorization: $http_authorization';
        more_set_headers -s 401 'WWW-Authenticate: Basic realm="exch.themainframe.co.uk"';

        location ~* ^/owa { proxy_pass https://exchange; }
        location ~* ^/Microsoft-Server-ActiveSync { proxy_pass https://exchange; }
        location ~* ^/ecp { proxy_pass https://exchange; }
        location ~* ^/rpc { proxy_pass https://exchange; }
        #location ~* ^/mailarchiver { proxy_pass https://mailarchiver.local; }

        error_log /var/log/nginx/owa-ssl-error.log;
        access_log /var/log/nginx/owa-ssl-access.log;
}
